% if settings.FEATURES.get('SEGMENT_IO_LMS'):
<!-- begin Segment.io -->
<%! from django.core.urlresolvers import reverse %>

<script type="text/javascript">
  // Asynchronously load Segment.io's analytics.js library
  window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
  analytics.load("${ settings.SEGMENT_IO_LMS_KEY }");
  analytics.page();

  % if user.is_authenticated():
    // Access the query string, stripping the leading "?"
    var queryString = window.location.search.substring(1);
    if (queryString != "") {
      // Convert the query string to a key/value object
      var parameters = window.parseQueryString(queryString);
      if ("signin" in parameters) {
        // Check if the user has logged in to enroll in a course - designed for when "Register" button registers users on click (currently, this could indicate a course registration when there may not have yet been one)
        var enrolledIn = window.checkRecentEnrollment(document.referrer);

        // Check if the user has just registered
        if (parameters.signin == "initial") {
          // Alias the user's anonymous history with the user's new identity (for Mixpanel)
          analytics.alias("${user.id}");

          // Map the user's activity to their newly assigned ID
          analytics.identify("${user.id}", {
            email: "${user.email}",
            username: "${user.username}"
          });

          // Track the user's account creation
          analytics.track("edx.user.account.registered", {
            category: "conversion",
            label: enrolledIn != null ? enrolledIn : "none"
          });
        } else {
          // Map the user's activity to their assigned ID
          analytics.identify("${user.id}", {
            email: "${user.email}",
            username: "${user.username}"
          });

          // Track the user's sign in
          analytics.track("edx.user.account.authenticated", {
            category: "conversion",
            label: enrolledIn != null ? enrolledIn : "none"
          });
        }
      } else {
        // If the signin parameter isn't present but the query string is non-empty, map the user's activity to their assigned ID
          analytics.identify("${user.id }", {
            email: "${user.email}",
            username: "${user.username}"
          });
      }
    } else {
      // If the query string is empty, map the user's activity to their assigned ID
      analytics.identify("${user.id }", {
        email: "${user.email}",
        username: "${user.username}"
      });
    }
  % endif

</script>
<!-- end Segment.io -->
% else:
<!-- dummy segment.io -->
<script type="text/javascript">
  var analytics = {
    track: function() { return; },
    pageview: function() { return; }
  };
</script>
<!-- end dummy segment.io -->
% endif
